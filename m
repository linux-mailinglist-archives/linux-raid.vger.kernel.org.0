Return-Path: <linux-raid+bounces-234-lists+linux-raid=lfdr.de@vger.kernel.org>
X-Original-To: lists+linux-raid@lfdr.de
Delivered-To: lists+linux-raid@lfdr.de
Received: from sv.mirrors.kernel.org (sv.mirrors.kernel.org [139.178.88.99])
	by mail.lfdr.de (Postfix) with ESMTPS id 0269C81AFD5
	for <lists+linux-raid@lfdr.de>; Thu, 21 Dec 2023 08:54:06 +0100 (CET)
Received: from smtp.subspace.kernel.org (wormhole.subspace.kernel.org [52.25.139.140])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by sv.mirrors.kernel.org (Postfix) with ESMTPS id B3B4D285C93
	for <lists+linux-raid@lfdr.de>; Thu, 21 Dec 2023 07:54:04 +0000 (UTC)
Received: from localhost.localdomain (localhost.localdomain [127.0.0.1])
	by smtp.subspace.kernel.org (Postfix) with ESMTP id 5F788156CB;
	Thu, 21 Dec 2023 07:53:58 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b="kZ2Ga1OS"
X-Original-To: linux-raid@vger.kernel.org
Received: from smtp.kernel.org (aws-us-west-2-korg-mail-1.web.codeaurora.org [10.30.226.201])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 067FF154BB;
	Thu, 21 Dec 2023 07:53:57 +0000 (UTC)
Received: by smtp.kernel.org (Postfix) with ESMTPSA id 85AD8C433C9;
	Thu, 21 Dec 2023 07:53:57 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
	s=k20201202; t=1703145237;
	bh=Zniq9fFh7CYXfCkclrR1BmQlS9tAvfFqLd2yx4PM9qg=;
	h=References:In-Reply-To:From:Date:Subject:To:Cc:From;
	b=kZ2Ga1OSSas/8HrDA0DHBfSa0urFoG8iWMiKaAPUuOQ61OYEXPphP5UUaUreKXpRZ
	 /jc63UtFGHYTTDqYAyiqnKfYysQ74w8olCK0mce1n5EAsUiaocWv+6C0pAIOY3+QSr
	 1hZOd/VNNfCyQKkjLONcDd1bxIhqKlwBJ0Mp4l4hfb0+Z+qzRSDhb1zsIg2z95WcbO
	 OI8mBKn8gsbFiU8sCEYcl/rWLJ/MmaAoMqSY8/zhSj5DUGi/tCUUXpb4N8hTCbNeiV
	 fd9GVWM3A3ubZJiXvaryz8e2nqxw+8E0PWLNCVtTsPJDi/oyERwapuHtkSqIXb4eW+
	 Zs/zcbS4Py8iw==
Received: by mail-lj1-f177.google.com with SMTP id 38308e7fff4ca-2cc259392a6so4785141fa.2;
        Wed, 20 Dec 2023 23:53:57 -0800 (PST)
X-Gm-Message-State: AOJu0Yx66DJItg+zQWuYK7C4hLy0cFqQvQ0LZENLqck7BS0k3DZg6qjZ
	l02IBUMmAbDgyXeteXAziyTKfNBFg+Dm5cFy2tc=
X-Google-Smtp-Source: AGHT+IGOoTMIt9w7fzlnd56F3v3rdh7FCJZC5qY+o4sQUK8vbjsKPHfoXAV77RrE97CwlYH7Ya3kR62WAfNz8SVdeXI=
X-Received: by 2002:a05:6512:1322:b0:50d:1f0c:2b24 with SMTP id
 x34-20020a056512132200b0050d1f0c2b24mr10407561lfu.20.1703145235724; Wed, 20
 Dec 2023 23:53:55 -0800 (PST)
Precedence: bulk
X-Mailing-List: linux-raid@vger.kernel.org
List-Id: <linux-raid.vger.kernel.org>
List-Subscribe: <mailto:linux-raid+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-raid+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
References: <20231221012715.3048221-1-song@kernel.org> <20231221012715.3048221-2-song@kernel.org>
 <ZYPXYdBAdNoKXI8b@infradead.org>
In-Reply-To: <ZYPXYdBAdNoKXI8b@infradead.org>
From: Song Liu <song@kernel.org>
Date: Wed, 20 Dec 2023 23:53:44 -0800
X-Gmail-Original-Message-ID: <CAPhsuW7qg0OwE3wx-mgcdZHUM1o7XY5CXMqJajtuib+sSEwxQw@mail.gmail.com>
Message-ID: <CAPhsuW7qg0OwE3wx-mgcdZHUM1o7XY5CXMqJajtuib+sSEwxQw@mail.gmail.com>
Subject: Re: [PATCH 1/2] block: Check REQ_OP_FLUSH in op_is_flush()
To: Christoph Hellwig <hch@infradead.org>
Cc: linux-block@vger.kernel.org, linux-raid@vger.kernel.org, axboe@kernel.dk, 
	kent.overstreet@linux.dev, janpieter.sollie@edpnet.be, colyli@suse.de, 
	bagasdotme@gmail.com
Content-Type: text/plain; charset="UTF-8"
Content-Transfer-Encoding: quoted-printable

On Wed, Dec 20, 2023 at 10:12=E2=80=AFPM Christoph Hellwig <hch@infradead.o=
rg> wrote:
>
> On Wed, Dec 20, 2023 at 05:27:14PM -0800, Song Liu wrote:
> > Upper layer (fs, etc.) may issue flush with something like:
> >
> >   bio_reset(bio, bdev, REQ_OP_FLUSH);
> >   bio->bi_end_io =3D xxx;
> >   submit_bio(bio);
>
> No, they can't.  REQ_OP_FLUSH is currently only used by request
> based drivers and only generated by the flush state machine.

Hmm... Then this call trace from bcachefs is the exception here:

bch2_journal_write=3D>
  submit_bio=3D>
    ...
    md_handle_request =3D>
      raid5_make_request =3D>
        chunk_aligned_read =3D>
          raid5_read_one_chunk =3D>

> (Not that I particularly like this wart, I'd much prefer file systems
> to submit a REQ_OP_FLUSH than an empty write with a preflush flag,
> but that's not a trivial change).

 Kent, I think we need to update how bcachefs issue flushes.

Thanks,
Song

